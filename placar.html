<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Placar MCI - Opera√ß√£o Iceberg</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Fredoka+One&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #0c1425;
        background-image: radial-gradient(
            circle at 15% 50%,
            rgba(100, 180, 255, 0.1),
            transparent 30%
          ),
          radial-gradient(
            circle at 85% 30%,
            rgba(150, 220, 255, 0.08),
            transparent 40%
          ),
          radial-gradient(
            circle at 50% 90%,
            rgba(50, 150, 220, 0.1),
            transparent 50%
          );
        color: #e2e8f0;
        font-family: "Inter", sans-serif;
        overflow-x: hidden;
        min-height: 100vh;
      }

      #team-logo {
        width: 300px;
        height: auto;
        margin-top: -9em;
      }

      .fun-font {
        font-family: "Fredoka One", cursive;
        letter-spacing: 1px;
      }
      .card-glow {
        box-shadow: 0 0 20px rgba(34, 211, 238, 0.15),
          0 0 8px rgba(34, 211, 238, 0.2);
        border: 1px solid rgba(56, 189, 248, 0.2);
        transition: all 0.3s ease;
      }
      .card-glow:hover {
        box-shadow: 0 0 30px rgba(34, 211, 238, 0.25),
          0 0 12px rgba(34, 211, 238, 0.3);
      }
      .iceberg-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        height: 450px;
        margin: auto;
      }
      .pulse-animation {
        animation: pulse 0.6s ease-out;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      .group-list {
        min-height: 150px;
      }

      #ice-wall {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 240px;
        display: flex;
        flex-wrap: wrap-reverse;
        gap: 8px 4px;
        padding: 10px;
        align-content: flex-start;
        justify-content: center;
        overflow-y: auto;
      }
      .ice-block {
        width: 100px;
        height: 110px;
        transition: all 0.5s ease;
        transform-origin: center;
        opacity: 1;
        clip-path: polygon(
          50% 0%,
          100% 25%,
          100% 75%,
          50% 100%,
          0% 75%,
          0% 25%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        text-align: center;
        font-size: 11px;
        color: #0c1425;
        font-weight: bold;
        line-height: 1.2;
        position: relative;
        cursor: default;
      }
      .ice-block.md1 {
        background: linear-gradient(145deg, #ffffff, #e0f2fe);
      }
      .ice-block.md2 {
        background: linear-gradient(145deg, #bae6fd, #38bdf8);
      }
      .ice-block.broken {
        color: #e2e8f0;
        background: transparent;
        flex-direction: column-reverse;
        gap: 2px;
        padding-bottom: 5px;
        clip-path: none;
      }
      .happy-penguin {
        width: 35px;
        height: 40px;
        opacity: 0;
        animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        animation-delay: 0.8s;
      }
      .broken-text {
        font-size: 10px;
        line-height: 1.1;
        opacity: 0;
        animation: fadeIn 0.5s forwards;
        animation-delay: 0.8s;
      }
      .ice-block.cracked::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M 20 20 L 50 50 L 45 55 L 70 80' stroke='rgba(0,0,0,0.3)' stroke-width='3' fill='none'/%3E%3Cpath d='M 50 50 L 80 40' stroke='rgba(0,0,0,0.3)' stroke-width='3' fill='none'/%3E%3C/svg%3E");
        background-size: 80%;
        background-repeat: no-repeat;
        background-position: center;
        animation: fadeIn 0.5s, tremble 2.5s ease-in-out infinite;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes pop-in {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes tremble {
        0%,
        100% {
          transform: rotate(0);
        }
        25% {
          transform: rotate(-1.5deg) translateX(-1px);
        }
        75% {
          transform: rotate(1.5deg) translateX(1px);
        }
      }

      #penguin-animator {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 100px;
        z-index: 30;
        transition: transform 0.7s ease-in-out;
      }
      #pickaxe {
        position: absolute;
        width: 65px;
        height: 65px;
        top: 15px;
        left: -25px;
        transform: rotate(-45deg);
        opacity: 0;
        transition: all 0.2s ease-in-out;
      }
      #penguin-animator.smashing #penguin {
        animation: penguin-body-smash 0.6s ease-in-out;
      }
      #penguin-animator.smashing #pickaxe {
        animation: pickaxe-smash 0.6s ease-in-out;
      }
      @keyframes penguin-body-smash {
        0% {
          transform: translateY(0) rotate(0deg);
        }
        30% {
          transform: translateY(-15px) rotate(-10deg);
        }
        60% {
          transform: translateY(5px) rotate(15deg) scale(1.05);
        }
        100% {
          transform: translateY(0) rotate(0deg);
        }
      }
      @keyframes pickaxe-smash {
        0% {
          opacity: 1;
          transform: rotate(-45deg) scale(1);
        }
        30% {
          opacity: 1;
          transform: rotate(20deg) scale(1.2);
        }
        60% {
          opacity: 1;
          transform: rotate(-60deg) scale(1);
        }
        100% {
          opacity: 0;
          transform: rotate(-45deg) scale(1);
        }
      }

      .ice-shard {
        position: absolute;
        width: 12px;
        height: 12px;
        background: #a5f3fc;
        clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        transform: translate(-50%, -50%);
        animation: fly-out 1s ease-out forwards;
        pointer-events: none;
        z-index: 50;
      }
      @keyframes fly-out {
        0% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
        100% {
          transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty)))
            scale(0) rotate(var(--r));
          opacity: 0;
        }
      }

      #sad-penguin-animator {
        position: absolute;
        width: 60px;
        height: 70px;
        z-index: 40;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out;
      }
      #sad-penguin-animator.crying {
        opacity: 1;
        animation: penguin-sob 2s ease-in-out;
      }
      #sad-penguin-animator.crying .tear {
        animation: tear-drop 2s ease-in-out;
      }
      @keyframes penguin-sob {
        0%,
        100% {
          transform: translateY(0) rotate(0);
          opacity: 0;
        }
        10% {
          transform: translateY(0) rotate(0);
          opacity: 1;
        }
        20%,
        60% {
          transform: translateY(0) rotate(-2deg);
        }
        40%,
        80% {
          transform: translateY(0) rotate(2deg);
        }
        90% {
          transform: translateY(0) rotate(0);
          opacity: 1;
        }
      }
      @keyframes tear-drop {
        0%,
        40% {
          transform: translateY(0);
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        90% {
          transform: translateY(30px);
          opacity: 0;
        }
        100% {
          opacity: 0;
        }
      }

      #motivational-phrase {
        position: absolute;
        top: 100px;
        left: 0;
        right: 0;
        text-align: center;
        font-family: "Fredoka One", cursive;
        font-size: 1.5rem;
        color: #67e8f9;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
        pointer-events: none;
        text-shadow: 0 0 10px rgba(103, 232, 249, 0.7);
      }
      #motivational-phrase.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .modal-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(12, 20, 37, 0.95);
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease-in-out;
      }
      .modal-screen.visible {
        opacity: 1;
        pointer-events: auto;
      }
      .victory-penguin {
        width: 60px;
        height: 70px;
        animation: jump 1.5s ease-in-out infinite;
      }
      @keyframes jump {
        0%,
        100% {
          transform: translateY(0) rotate(0);
        }
        25% {
          transform: translateY(-30px) rotate(-10deg);
        }
        50% {
          transform: translateY(0) rotate(0);
        }
        75% {
          transform: translateY(-15px) rotate(10deg);
        }
      }
    </style>
  </head>
  <body class="p-8 md:p-12">
    <div class="max-w-7xl mx-auto relative">
      <img
        id="team-logo"
        src="equipe.png"
        alt="Log√≥tipo da Equipa"
        class="absolute top-0 left-0 w-24 h-24 rounded-full"
      />
      <button
        id="history-btn"
        class="absolute top-0 right-0 fun-font bg-cyan-700 hover:bg-cyan-600 text-white text-lg py-2 px-4 rounded-lg shadow-lg transform hover:scale-105 transition-transform"
      >
        üìú Hist√≥rico
      </button>

      <div class="text-center mb-12">
        <h1 class="fun-font text-4xl md:text-6xl text-cyan-300 tracking-wide">
          Placar MCI
        </h1>
        <p
          class="fun-font text-xl md:text-2xl text-cyan-400 opacity-90 -mt-2 md:-mt-3"
        >
          Opera√ß√£o Quebra-Gelo
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
        <div class="md:col-span-2 flex flex-col gap-8">
          <!-- MD 1 -->
          <div class="bg-slate-800 p-6 rounded-lg card-glow">
            <h2 class="fun-font text-3xl mb-4 text-center text-cyan-400">
              MD 1
            </h2>
            <div class="flex mb-4">
              <input
                type="text"
                id="group-input-1"
                class="w-full bg-slate-700 text-white p-2 rounded-l-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                placeholder="Adicionar Semana (ex: 01/10 a 07/10)..."
              />
              <button
                id="add-group-btn-1"
                class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-3 rounded-r-md transform hover:scale-110 transition-transform duration-200"
              >
                +
              </button>
            </div>
            <div
              id="md-stats-1"
              class="text-xs text-slate-400 flex justify-around mb-4 border-t border-b border-slate-700 py-2"
            >
              <span
                >Total Metas:
                <span id="md-total-1" class="font-bold text-base text-white"
                  >0</span
                ></span
              >
              <span class="text-green-400"
                >Conclu√≠das:
                <span id="md-completed-1" class="font-bold text-base"
                  >0</span
                ></span
              >
              <span class="text-red-400"
                >N√£o Conclu√≠das:
                <span id="md-failed-1" class="font-bold text-base"
                  >0</span
                ></span
              >
            </div>
            <div
              id="group-list-1"
              class="group-list space-y-4 max-h-80 overflow-y-auto pr-2"
            ></div>
          </div>
          <!-- MD 2 -->
          <div class="bg-slate-800 p-6 rounded-lg card-glow">
            <h2 class="fun-font text-3xl mb-4 text-center text-cyan-400">
              MD 2
            </h2>
            <div class="flex mb-4">
              <input
                type="text"
                id="group-input-2"
                class="w-full bg-slate-700 text-white p-2 rounded-l-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                placeholder="Adicionar Semana (ex: 08/10 a 14/10)..."
              />
              <button
                id="add-group-btn-2"
                class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-3 rounded-r-md transform hover:scale-110 transition-transform duration-200"
              >
                +
              </button>
            </div>
            <div
              id="md-stats-2"
              class="text-xs text-slate-400 flex justify-around mb-4 border-t border-b border-slate-700 py-2"
            >
              <span
                >Total Metas:
                <span id="md-total-2" class="font-bold text-base text-white"
                  >0</span
                ></span
              >
              <span class="text-green-400"
                >Conclu√≠das:
                <span id="md-completed-2" class="font-bold text-base"
                  >0</span
                ></span
              >
              <span class="text-red-400"
                >N√£o Conclu√≠das:
                <span id="md-failed-2" class="font-bold text-base"
                  >0</span
                ></span
              >
            </div>
            <div
              id="group-list-2"
              class="group-list space-y-4 max-h-80 overflow-y-auto pr-2"
            ></div>
          </div>
        </div>

        <!-- Coluna do Placar -->
        <div
          class="md:col-span-3 bg-slate-800 p-6 rounded-lg card-glow flex flex-col items-center"
        >
          <div id="stats" class="text-center mb-4 w-full">
            <p class="text-lg mb-2">Progresso da Semana Atual</p>
            <div class="flex justify-around items-start">
              <div class="px-4">
                <p class="fun-font text-xl text-cyan-400">MD 1</p>
                <p
                  id="progress-text-1"
                  class="fun-font font-bold text-6xl text-cyan-300"
                >
                  0%
                </p>
                <p class="text-sm text-slate-400">
                  <span id="completed-count-1">0</span> de
                  <span id="total-count-1">0</span> metas
                </p>
              </div>
              <div class="border-l border-slate-600 self-stretch mx-4"></div>
              <div class="px-4">
                <p class="fun-font text-xl text-cyan-400">MD 2</p>
                <p
                  id="progress-text-2"
                  class="fun-font font-bold text-6xl text-cyan-300"
                >
                  0%
                </p>
                <p class="text-sm text-slate-400">
                  <span id="completed-count-2">0</span> de
                  <span id="total-count-2">0</span> metas
                </p>
              </div>
            </div>
          </div>
          <div class="iceberg-container">
            <div id="ice-wall"></div>
            <div id="penguin-animator">
              <svg id="penguin" viewBox="0 0 60 70" class="w-full h-full">
                <path
                  d="M30,0 C10,0 0,20 0,40 C0,65 15,70 30,70 C45,70 60,65 60,40 C60,20 50,0 30,0 Z"
                  fill="#333"
                />
                <path
                  d="M30,15 C20,15 12,25 12,40 C12,55 20,60 30,60 C40,60 48,55 48,40 C48,25 40,15 30,15 Z"
                  fill="white"
                />
                <circle cx="22" cy="30" r="3" fill="#333" />
                <circle cx="38" cy="30" r="3" fill="#333" />
                <polygon points="27,38 33,38 30,45" fill="orange" />
                <ellipse cx="20" cy="68" rx="8" ry="4" fill="orange" />
                <ellipse cx="40" cy="68" rx="8" ry="4" fill="orange" />
              </svg>
              <svg id="pickaxe" viewBox="0 0 100 100">
                <g transform="rotate(135 50 50)">
                  <rect
                    x="45"
                    y="0"
                    width="10"
                    height="100"
                    fill="#8B5A2B"
                    rx="3"
                  />
                  <path
                    d="M10,40 Q50,25 90,40 L95,50 Q50,35 5,50 Z"
                    fill="#7f8c8d"
                  />
                  <rect x="40" y="38" width="20" height="15" fill="#593a1c" />
                  <path
                    d="M15,41 Q50,30 85,41 L90,48 Q50,37 10,48 Z"
                    fill="#95a5a6"
                  />
                </g>
              </svg>
            </div>
            <div id="sad-penguin-animator">
              <svg viewBox="0 0 60 70" class="w-full h-full">
                <path
                  d="M30,0 C10,0 0,20 0,40 C0,65 15,70 30,70 C45,70 60,65 60,40 C60,20 50,0 30,0 Z"
                  fill="#333"
                />
                <path
                  d="M30,15 C20,15 12,25 12,40 C12,55 20,60 30,60 C40,60 48,55 48,40 C48,25 40,15 30,15 Z"
                  fill="white"
                />
                <path
                  d="M20 32 C 22 28, 28 28, 30 32"
                  stroke="#333"
                  stroke-width="2"
                  fill="none"
                />
                <path
                  d="M40 32 C 38 28, 32 28, 30 32"
                  stroke="#333"
                  stroke-width="2"
                  fill="none"
                />
                <polygon points="27,42 33,42 30,37" fill="orange" />
                <ellipse cx="20" cy="68" rx="8" ry="4" fill="orange" />
                <ellipse cx="40" cy="68" rx="8" ry="4" fill="orange" />
                <path
                  class="tear"
                  d="M22 35 C 22 40, 18 40, 18 35 C 18 30, 22 30, 22 35 Z"
                  fill="#67e8f9"
                />
              </svg>
            </div>
            <div id="motivational-phrase"></div>
          </div>
        </div>
      </div>

      <!-- Report Tracker - Full Width -->
      <div class="mt-8 bg-slate-800 p-6 rounded-lg card-glow">
        <div class="flex justify-center items-center mb-4">
          <h2 class="fun-font text-3xl text-center text-cyan-400">
            Acompanhamento de Reports
          </h2>
          <button
            id="expand-main-chart-btn"
            class="ml-4 text-2xl"
            title="Expandir Gr√°fico"
          >
            ‚ÜóÔ∏è
          </button>
        </div>
        <div class="grid md:grid-cols-3 gap-8 items-center">
          <div class="md:col-span-1">
            <div class="space-y-2 max-w-sm mx-auto">
              <div class="text-center mb-2 grid grid-cols-2 gap-4">
                <div>
                  <p class="text-sm font-medium text-slate-400">
                    Valor Inicial
                  </p>
                  <p class="fun-font text-2xl text-red-400">1.127</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-slate-400">Meta Final</p>
                  <p class="fun-font text-2xl text-green-400">450</p>
                </div>
              </div>
              <div>
                <label
                  for="report-count-input"
                  class="text-sm font-medium text-slate-400"
                  >Reports abertos na semana</label
                >
                <input
                  type="number"
                  id="report-count-input"
                  class="w-full bg-slate-700 text-white p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                  placeholder="Insira o total da semana..."
                />
              </div>
              <button
                id="add-report-btn"
                class="w-full fun-font bg-cyan-600 hover:bg-cyan-700 text-white py-2 px-4 rounded-lg shadow-lg transform hover:scale-105 transition-transform"
              >
                Adicionar Registro da Semana
              </button>
            </div>
          </div>
          <div class="md:col-span-2 relative h-80">
            <canvas id="reportChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div id="results-screen" class="modal-screen p-4">
      <div
        class="bg-slate-800 p-6 md:p-8 rounded-lg card-glow w-full max-w-3xl text-center transform scale-95 transition-transform duration-300"
      >
        <h2 id="results-title" class="fun-font text-4xl text-cyan-300 mb-2">
          Fim da Semana!
        </h2>
        <div
          id="results-feedback"
          class="my-4 h-auto flex flex-col justify-center items-center"
        ></div>
        <div
          id="results-percentages"
          class="flex justify-around text-base mb-4 font-semibold w-full"
        ></div>
        <div class="grid md:grid-cols-2 gap-6 items-center">
          <div class="relative w-full max-w-xs mx-auto">
            <h3 class="fun-font text-xl text-cyan-400 mb-2">
              Resultado das Metas
            </h3>
            <canvas id="resultsChart"></canvas>
          </div>
          <div class="relative w-full h-64">
            <h3 class="fun-font text-xl text-cyan-400 mb-2">
              Evolu√ß√£o dos Reports
            </h3>
            <canvas id="resultsReportChart"></canvas>
          </div>
        </div>
        <button
          id="finalize-week-btn"
          class="mt-8 fun-font bg-cyan-600 hover:bg-cyan-700 text-white text-xl py-2 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-transform"
        >
          Finalizar Semana
        </button>
      </div>
    </div>

    <div id="victory-screen" class="modal-screen">
      <h2 class="fun-font text-4xl md:text-5xl text-cyan-300 mb-4 text-center">
        Semana Perfeita!
      </h2>
      <p class="text-xl text-slate-300 mb-6 text-center">
        Voc√™s quebraram todo o gelo! Parab√©ns, equipe!
      </p>
      <div class="flex space-x-8 mb-8">
        <div class="victory-penguin" style="animation-delay: 0s">
          <svg viewBox="0 0 60 70">
            <path
              d="M30,0 C10,0 0,20 0,40 C0,65 15,70 30,70 C45,70 60,65 60,40 C60,20 50,0 30,0 Z"
              fill="#333"
            />
            <path
              d="M30,15 C20,15 12,25 12,40 C12,55 20,60 30,60 C40,60 48,55 48,40 C48,25 40,15 30,15 Z"
              fill="white"
            />
            <circle cx="22" cy="30" r="3" fill="#333" />
            <circle cx="38" cy="30" r="3" fill="#333" />
            <polygon points="27,38 33,38 30,45" fill="orange" />
            <ellipse cx="20" cy="68" rx="8" ry="4" fill="orange" />
            <ellipse cx="40" cy="68" rx="8" ry="4" fill="orange" />
          </svg>
        </div>
        <div class="victory-penguin" style="animation-delay: 0.2s">
          <svg viewBox="0 0 60 70">
            <path
              d="M30,0 C10,0 0,20 0,40 C0,65 15,70 30,70 C45,70 60,65 60,40 C60,20 50,0 30,0 Z"
              fill="#333"
            />
            <path
              d="M30,15 C20,15 12,25 12,40 C12,55 20,60 30,60 C40,60 48,55 48,40 C48,25 40,15 30,15 Z"
              fill="white"
            />
            <circle cx="22" cy="30" r="3" fill="#333" />
            <circle cx="38" cy="30" r="3" fill="#333" />
            <polygon points="27,38 33,38 30,45" fill="orange" />
            <ellipse cx="20" cy="68" rx="8" ry="4" fill="orange" />
            <ellipse cx="40" cy="68" rx="8" ry="4" fill="orange" />
          </svg>
        </div>
        <div class="victory-penguin" style="animation-delay: 0.4s">
          <svg viewBox="0 0 60 70">
            <path
              d="M30,0 C10,0 0,20 0,40 C0,65 15,70 30,70 C45,70 60,65 60,40 C60,20 50,0 30,0 Z"
              fill="#333"
            />
            <path
              d="M30,15 C20,15 12,25 12,40 C12,55 20,60 30,60 C40,60 48,55 48,40 C48,25 40,15 30,15 Z"
              fill="white"
            />
            <circle cx="22" cy="30" r="3" fill="#333" />
            <circle cx="38" cy="30" r="3" fill="#333" />
            <polygon points="27,38 33,38 30,45" fill="orange" />
            <ellipse cx="20" cy="68" rx="8" ry="4" fill="orange" />
            <ellipse cx="40" cy="68" rx="8" ry="4" fill="orange" />
          </svg>
        </div>
      </div>
      <button
        id="new-week-btn"
        class="fun-font bg-cyan-600 hover:bg-cyan-700 text-white text-2xl py-3 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-transform"
      >
        Come√ßar Nova Semana
      </button>
    </div>

    <div id="history-screen" class="modal-screen p-4 md:p-8">
      <div
        class="bg-slate-800 p-6 md:p-8 rounded-lg card-glow w-full max-w-4xl text-center transform scale-95 transition-transform duration-300 relative"
      >
        <button
          id="close-history-btn"
          class="absolute top-2 right-4 text-4xl text-slate-400 hover:text-white"
        >
          &times;
        </button>
        <h2 class="fun-font text-4xl text-cyan-300 mb-6">
          Hist√≥rico de Semanas
        </h2>
        <div
          id="history-content"
          class="max-h-[70vh] overflow-y-auto space-y-6 text-left pr-4"
        >
          <!-- History items will be injected here -->
        </div>
      </div>
    </div>

    <!-- Chart Modal -->
    <div id="chart-modal" class="modal-screen p-4 md:p-8">
      <div
        class="bg-slate-800 p-6 md:p-8 rounded-lg card-glow w-full max-w-4xl h-[80vh] text-center transform scale-95 transition-transform duration-300 relative flex flex-col"
      >
        <button
          id="close-chart-modal-btn"
          class="absolute top-2 right-4 text-4xl text-slate-400 hover:text-white"
        >
          &times;
        </button>
        <h2 id="chart-modal-title" class="fun-font text-3xl text-cyan-300 mb-4">
          Evolu√ß√£o dos Reports
        </h2>
        <div class="relative flex-grow">
          <canvas id="expandedReportChart"></canvas>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const teamImageBase64 =
          "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAHWAdoDASIAAhEBAxEB/8QAHQAAAQQDAQEAAAAAAAAAAAAAAAECBAUDBgcICf/EAGMQAAEDAwMCAwUEBw0LBgMFAAEAAgMEBREGEiExBxNBURQiYXEIFDKBoRYjJEKxFhczUmJzgpLSFzU2N0NVVXR1g6KkscElJjZERVRkdpWzwuHwKDhGo3aUwtImNqPi/8QAGwEAAwEBAQEBAAAAAAAAAAAAAAECAwQFBgf/xAA5EQACAQIEAwQJAwMEAwEAAAAAAQIDEQQSITEFQVETImFxkaEGFDKBscHR8BUiM+EjQ/EWUmJykv/aAAwDAQACEQMRAD8A+qUIiIAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQAREQ";
        const iceWall = document.getElementById("ice-wall");
        const penguinAnimator = document.getElementById("penguin-animator");
        const sadPenguinAnimator = document.getElementById(
          "sad-penguin-animator"
        );
        const motivationalPhraseEl = document.getElementById(
          "motivational-phrase"
        );
        const resultsScreen = document.getElementById("results-screen");
        const finalizeWeekBtn = document.getElementById("finalize-week-btn");
        const victoryScreen = document.getElementById("victory-screen");
        const newWeekBtn = document.getElementById("new-week-btn");
        const historyBtn = document.getElementById("history-btn");
        const historyScreen = document.getElementById("history-screen");
        const closeHistoryBtn = document.getElementById("close-history-btn");
        const addReportBtn = document.getElementById("add-report-btn");
        const reportCountInput = document.getElementById("report-count-input");
        const expandMainChartBtn = document.getElementById(
          "expand-main-chart-btn"
        );
        const chartModal = document.getElementById("chart-modal");
        const closeChartModalBtn = document.getElementById(
          "close-chart-modal-btn"
        );

        const phrases = [
          "Mandou bem!",
          "√â isso a√≠!",
          "Congelando a concorr√™ncia!",
          "Mais um pra conta!",
          "Quebrou tudo!",
          "Ningu√©m segura essa equipa!",
          "Show de bola!",
        ];
        let weekData = { groups: [] };
        let history = JSON.parse(localStorage.getItem("mciHistory")) || [];
        let reportData = JSON.parse(localStorage.getItem("mciReportData")) || {
          weeks: [],
          counts: [],
        };

        let audioCtx;
        let resultsChartInstance = null;
        let reportChartInstance = null;
        let resultsReportChartInstance = null;
        let expandedReportChartInstance = null;

        function initializeApp() {
          loadWeekData();
          setupMD(1);
          setupMD(2);
          finalizeWeekBtn.addEventListener("click", () => {
            resultsScreen.classList.remove("visible");
            saveWeekAndReset();
          });
          newWeekBtn.addEventListener("click", () => {
            victoryScreen.classList.remove("visible");
            saveWeekAndReset();
          });
          historyBtn.addEventListener("click", showHistory);
          closeHistoryBtn.addEventListener("click", () =>
            historyScreen.classList.remove("visible")
          );
          addReportBtn.addEventListener("click", addReportEntry);
          expandMainChartBtn.addEventListener("click", () =>
            expandChart(reportData)
          );
          closeChartModalBtn.addEventListener("click", () =>
            chartModal.classList.remove("visible")
          );
          document.getElementById("team-logo").src = equipe;
          renderAll();
          renderReportChart(reportData, "reportChart", false);
        }

        function loadWeekData() {
          const savedWeek = localStorage.getItem("mciCurrentWeek");
          if (savedWeek) {
            weekData = JSON.parse(savedWeek);
          } else {
            weekData = { groups: [] };
          }
        }

        function saveCurrentWeek() {
          localStorage.setItem("mciCurrentWeek", JSON.stringify(weekData));
        }

        function setupMD(mdIndex) {
          const groupInput = document.getElementById(`group-input-${mdIndex}`);
          const addGroupButton = document.getElementById(
            `add-group-btn-${mdIndex}`
          );
          addGroupButton.addEventListener("click", () =>
            addGroup(groupInput, mdIndex)
          );
          groupInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") addGroup(groupInput, mdIndex);
          });
        }

        function getNextId() {
          return "id" + Date.now() + Math.random().toString(36).substring(2);
        }

        function addGroup(input, mdIndex) {
          const text = input.value.trim();
          if (text) {
            weekData.groups.push({
              id: getNextId(),
              text,
              md: mdIndex,
              commitments: [],
            });
            input.value = "";
            renderAll();
          }
        }

        function addCommitment(groupId, text) {
          const group = findGroup(groupId);
          if (group && text) {
            group.commitments.push({
              id: getNextId(),
              text,
              status: "pending",
              tasks: [],
            });
            renderAll();
          }
        }

        function addTask(commitmentId, text) {
          const { commitment } = findCommitment(commitmentId);
          if (commitment && text) {
            commitment.tasks.push({ id: getNextId(), text, completed: false });
            renderAll();
          }
        }

        function findGroup(groupId) {
          return weekData.groups.find((g) => g.id === groupId);
        }

        function findCommitment(commitmentId) {
          for (const group of weekData.groups) {
            const commitment = group.commitments.find(
              (c) => c.id === commitmentId
            );
            if (commitment) return { group, commitment };
          }
          return {};
        }

        function findTask(taskId) {
          for (const group of weekData.groups) {
            for (const commitment of group.commitments) {
              const task = commitment.tasks.find((t) => t.id === taskId);
              if (task) return { commitment, task };
            }
          }
          return {};
        }

        function deleteGroup(groupId) {
          weekData.groups = weekData.groups.filter((g) => g.id !== groupId);
          renderAll();
        }

        function deleteCommitment(commitmentId) {
          const { group } = findCommitment(commitmentId);
          if (group) {
            group.commitments = group.commitments.filter(
              (c) => c.id !== commitmentId
            );
            renderAll();
          }
        }

        function deleteTask(taskId) {
          const { commitment } = findTask(taskId);
          if (commitment) {
            commitment.tasks = commitment.tasks.filter((t) => t.id !== taskId);
            renderAll();
          }
        }

        function toggleTask(taskId) {
          const { task } = findTask(taskId);
          if (task) {
            task.completed = !task.completed;
            renderAll();
          }
        }

        async function toggleCommitmentStatus(commitmentId, status) {
          if (document.body.classList.contains("animating")) return;
          const { commitment } = findCommitment(commitmentId);
          if (!commitment) return;
          commitment.status = status;

          if (status === "pending") {
            renderAll();
            return;
          }

          document.body.classList.add("animating");

          if (status === "completed") {
            const targetBlock = document.getElementById(commitment.id);
            if (targetBlock) targetBlock.style.opacity = "0";
            await animatePenguinBreak(commitment.id);
          } else if (status === "failed") {
            playCrackSound();
            await animateSadPenguin(commitment.id);
          }

          renderAll();

          setTimeout(() => {
            document.body.classList.remove("animating");
            updateScoreboard();
          }, 2100);
        }

        function renderAll() {
          renderGroupLists();
          renderIceWall();
          updateScoreboard();
          saveCurrentWeek();
        }

        function renderGroupLists() {
          document.getElementById("group-list-1").innerHTML = "";
          document.getElementById("group-list-2").innerHTML = "";
          weekData.groups.forEach((group) => {
            const groupList = document.getElementById(`group-list-${group.md}`);
            const groupDiv = document.createElement("div");
            groupDiv.className = "bg-slate-700/50 p-3 rounded-lg";
            groupDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-cyan-300">${group.text}</h3>
                        <button class="delete-group-btn" data-id="${group.id}">üóëÔ∏è</button>
                    </div>
                    <div class="commitments-list space-y-3" id="cl-${group.id}"></div>
                    <div class="flex mt-3">
                        <input type="text" class="add-commitment-input w-full bg-slate-600 text-white p-1.5 rounded-l-md text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500" placeholder="Adicionar meta...">
                        <button class="add-commitment-btn bg-cyan-700 hover:bg-cyan-600 text-white font-bold p-2 rounded-r-md text-xs" data-id="${group.id}">+</button>
                    </div>
                `;
            groupList.appendChild(groupDiv);
            renderCommitments(group);
          });
          attachEventListeners();
        }

        function renderCommitments(group) {
          const commitmentsList = document.getElementById(`cl-${group.id}`);
          group.commitments.forEach((commitment) => {
            const commitmentDiv = document.createElement("div");
            const statusClass =
              commitment.status === "completed"
                ? "bg-green-800/40"
                : commitment.status === "failed"
                ? "bg-red-800/40"
                : "bg-slate-600/50";
            commitmentDiv.className = `p-2 rounded-md ${statusClass}`;

            let tasksHTML =
              '<div class="tasks-list space-y-1 mt-2 pl-2 border-l-2 border-slate-500">';
            commitment.tasks.forEach((task) => {
              tasksHTML += `
                        <div class="flex items-center text-sm">
                            <input type="checkbox" class="task-checkbox mr-2" data-id="${
                              task.id
                            }" ${task.completed ? "checked" : ""}>
                            <span class="${
                              task.completed
                                ? "line-through text-slate-400"
                                : ""
                            }">${task.text}</span>
                            <button class="delete-task-btn ml-auto text-xs" data-id="${
                              task.id
                            }">üóëÔ∏è</button>
                        </div>
                    `;
            });
            tasksHTML += "</div>";

            commitmentDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="${
                          commitment.status !== "pending" ? "opacity-70" : ""
                        }">${commitment.text}</span>
                        <div class="flex items-center space-x-1">
                            ${
                              commitment.status === "pending" ||
                              commitment.status === "failed"
                                ? `<button class="complete-commitment-btn text-xs" data-id="${commitment.id}">‚úÖ</button>`
                                : ""
                            }
                            ${
                              commitment.status === "pending" ||
                              commitment.status === "completed"
                                ? `<button class="fail-commitment-btn text-xs" data-id="${commitment.id}">‚ùå</button>`
                                : ""
                            }
                            <button class="delete-commitment-btn text-xs" data-id="${
                              commitment.id
                            }">üóëÔ∏è</button>
                        </div>
                    </div>
                    ${tasksHTML}
                    <div class="flex mt-2">
                        <input type="text" class="add-task-input w-full bg-slate-500 text-white p-1 rounded-l-md text-xs focus:outline-none focus:ring-1 focus:ring-cyan-500" placeholder="Adicionar tarefa...">
                        <button class="add-task-btn bg-cyan-800 hover:bg-cyan-700 text-white font-bold p-1.5 rounded-r-md text-xs" data-id="${
                          commitment.id
                        }">+</button>
                    </div>
                `;
            commitmentsList.appendChild(commitmentDiv);
          });
        }

        function attachEventListeners() {
          document
            .querySelectorAll(".delete-group-btn")
            .forEach((b) => (b.onclick = () => deleteGroup(b.dataset.id)));
          document.querySelectorAll(".add-commitment-btn").forEach((b) => {
            const input = b.previousElementSibling;
            b.onclick = () => addCommitment(b.dataset.id, input.value.trim());
            input.onkeypress = (e) => {
              if (e.key === "Enter")
                addCommitment(b.dataset.id, input.value.trim());
            };
          });
          document
            .querySelectorAll(".complete-commitment-btn")
            .forEach(
              (b) =>
                (b.onclick = () =>
                  toggleCommitmentStatus(b.dataset.id, "completed"))
            );
          document
            .querySelectorAll(".fail-commitment-btn")
            .forEach(
              (b) =>
                (b.onclick = () =>
                  toggleCommitmentStatus(b.dataset.id, "failed"))
            );
          document
            .querySelectorAll(".delete-commitment-btn")
            .forEach((b) => (b.onclick = () => deleteCommitment(b.dataset.id)));
          document.querySelectorAll(".add-task-btn").forEach((b) => {
            const input = b.previousElementSibling;
            b.onclick = () => {
              addTask(b.dataset.id, input.value.trim());
              input.value = "";
            };
            input.onkeypress = (e) => {
              if (e.key === "Enter") {
                addTask(b.dataset.id, input.value.trim());
                input.value = "";
              }
            };
          });
          document
            .querySelectorAll(".task-checkbox")
            .forEach((cb) => (cb.onchange = () => toggleTask(cb.dataset.id)));
          document
            .querySelectorAll(".delete-task-btn")
            .forEach((b) => (b.onclick = () => deleteTask(b.dataset.id)));
        }

        function renderIceWall() {
          iceWall.innerHTML = "";
          const allCommitments = weekData.groups
            .flatMap((g) => g.commitments.map((c) => ({ ...c, md: g.md })))
            .sort((a, b) => a.md - b.md);
          allCommitments.forEach((commitment) => {
            const block = document.createElement("div");
            block.id = commitment.id;
            block.className = `ice-block ${
              commitment.md === 1 ? "md1" : "md2"
            }`;
            if (commitment.status === "completed") {
              block.classList.add("broken");
              block.innerHTML = `
                        <svg class="happy-penguin" viewBox='0 0 60 70'><path d='M30,0 C10,0 0,20 0,40 C0,65 15,70 30,70 C45,70 60,65 60,40 C60,20 50,0 30,0 Z' fill='#333'/><path d='M30,15 C20,15 12,25 12,40 C12,55 20,60 30,60 C40,60 48,55 48,40 C48,25 40,15 30,15 Z' fill='white'/><path d='M20 28 L26 32 L20 32 Z' fill='#333'/><path d='M34 32 L40 28 L40 32 Z' fill='#333'/><polygon points='27,38 33,38 30,45' fill='orange'/><ellipse cx='20' cy='68' rx='8' ry='4' fill='orange'/><ellipse cx='40' cy='68' rx='8' ry='4' fill='orange'/></svg>
                        <span class="broken-text">${commitment.text}</span>`;
            } else {
              block.textContent = commitment.text;
              if (commitment.status === "failed")
                block.classList.add("cracked");
            }
            iceWall.appendChild(block);
          });
        }

        function updateScoreboard() {
          const allCommitments = weekData.groups.flatMap((g) =>
            g.commitments.map((c) => ({ ...c, md: g.md }))
          );
          ["1", "2"].forEach((mdIndex) => {
            const md = parseInt(mdIndex);
            const commitments = allCommitments.filter((c) => c.md === md);
            const total = commitments.length;
            const completed = commitments.filter(
              (c) => c.status === "completed"
            ).length;
            const failed = commitments.filter(
              (c) => c.status === "failed"
            ).length;
            const percentage =
              total > 0 ? Math.round((completed / total) * 100) : 0;

            const progressText = document.getElementById(
              `progress-text-${mdIndex}`
            );
            if (progressText.textContent !== `${percentage}%`) {
              progressText.textContent = `${percentage}%`;
              progressText.classList.add("pulse-animation");
              setTimeout(
                () => progressText.classList.remove("pulse-animation"),
                600
              );
            }
            document.getElementById(`completed-count-${mdIndex}`).textContent =
              completed;
            document.getElementById(`total-count-${mdIndex}`).textContent =
              total;
            document.getElementById(`md-total-${mdIndex}`).textContent = total;
            document.getElementById(`md-completed-${mdIndex}`).textContent =
              completed;
            document.getElementById(`md-failed-${mdIndex}`).textContent =
              failed;
          });

          const totalCommitments = allCommitments.length;
          const finishedCommitments = allCommitments.filter(
            (c) => c.status !== "pending"
          ).length;
          if (
            totalCommitments > 0 &&
            finishedCommitments === totalCommitments &&
            !resultsScreen.classList.contains("visible")
          ) {
            setTimeout(showEndState, 800);
          }
        }

        function showEndState() {
          const allCommitments = weekData.groups.flatMap((g) => g.commitments);
          const completed = allCommitments.filter(
            (c) => c.status === "completed"
          ).length;
          const total = allCommitments.length;
          const percentage =
            total > 0 ? Math.round((completed / total) * 100) : 0;

          const completedMD1 = weekData.groups
            .filter((g) => g.md === 1)
            .flatMap((c) => c.commitments)
            .filter((c) => c.status === "completed").length;
          const failedMD1 = weekData.groups
            .filter((g) => g.md === 1)
            .flatMap((c) => c.commitments)
            .filter((c) => c.status === "failed").length;
          const completedMD2 = weekData.groups
            .filter((g) => g.md === 2)
            .flatMap((c) => c.commitments)
            .filter((c) => c.status === "completed").length;
          const failedMD2 = weekData.groups
            .filter((g) => g.md === 2)
            .flatMap((c) => c.commitments)
            .filter((c) => c.status === "failed").length;

          const totalMD1 = completedMD1 + failedMD1;
          const totalMD2 = completedMD2 + failedMD2;
          const percMD1 =
            totalMD1 > 0 ? Math.round((completedMD1 / totalMD1) * 100) : 0;
          const percMD2 =
            totalMD2 > 0 ? Math.round((completedMD2 / totalMD2) * 100) : 0;

          document.getElementById("results-percentages").innerHTML = `
                <div class="text-center">
                    <p class="fun-font text-lg text-cyan-400">MD 1</p>
                    <p class="text-green-400">‚úÖ ${percMD1}% Conclu√≠das</p>
                </div>
                <div class="text-center">
                    <p class="fun-font text-lg text-cyan-400">MD 2</p>
                    <p class="text-green-400">‚úÖ ${percMD2}% Conclu√≠das</p>
                </div>`;

          if (percentage === 100) {
            document.getElementById("results-title").textContent =
              "Semana Perfeita!";
            document.getElementById(
              "results-feedback"
            ).innerHTML = `<p class="text-xl text-slate-300 mb-6 text-center">Voc√™s quebraram todo o gelo! Parab√©ns, equipe!</p>`;
          } else {
            document.getElementById("results-title").textContent =
              "Fim da Semana!";
            document.getElementById(
              "results-feedback"
            ).innerHTML = `<p class="text-slate-300 text-lg mb-4 px-4">Alguns gelos n√£o quebraram, mas seguimos em frente!</p>`;
          }

          resultsScreen.classList.add("visible");
          renderResultsChart(completedMD1, failedMD1, completedMD2, failedMD2);
          renderReportChart(reportData, "resultsReportChart", false);
        }

        function saveWeekAndReset() {
          if (weekData.groups.length > 0) {
            const finishedWeek = JSON.parse(JSON.stringify(weekData)); // Deep copy
            finishedWeek.date = new Date().toLocaleDateString("pt-BR");
            finishedWeek.reportChartData = JSON.parse(
              JSON.stringify(reportData)
            );
            history.unshift(finishedWeek);
            localStorage.setItem("mciHistory", JSON.stringify(history));
          }
          weekData = { groups: [] };
          localStorage.removeItem("mciCurrentWeek");
          renderAll();
        }

        function initAudio() {
          if (!audioCtx) {
            try {
              audioCtx = new (window.AudioContext ||
                window.webkitAudioContext)();
            } catch (e) {
              console.error("Web Audio API not supported");
            }
          }
        }
        function playCrackSound() {
          initAudio();
          if (!audioCtx) return;
          const bufferSize = audioCtx.sampleRate * 0.2,
            buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
          let data = buffer.getChannelData(0);
          for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
          const source = audioCtx.createBufferSource();
          source.buffer = buffer;
          const gainNode = audioCtx.createGain();
          gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioCtx.currentTime + 0.18
          );
          source.connect(gainNode);
          gainNode.connect(audioCtx.destination);
          source.start(0);
        }
        function playPickaxeSound() {
          initAudio();
          if (!audioCtx) return;
          const osc = audioCtx.createOscillator(),
            gain = audioCtx.createGain();
          osc.type = "square";
          osc.frequency.setValueAtTime(800, audioCtx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(
            200,
            audioCtx.currentTime + 0.1
          );
          gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.01,
            audioCtx.currentTime + 0.15
          );
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.15);
        }

        async function animateSadPenguin(commitmentId) {
          const targetBlock = document.getElementById(commitmentId);
          if (!targetBlock) return;
          const cRect =
              sadPenguinAnimator.parentElement.getBoundingClientRect(),
            tRect = targetBlock.getBoundingClientRect();
          const tX =
              tRect.left -
              cRect.left +
              tRect.width / 2 -
              sadPenguinAnimator.offsetWidth / 2,
            tY = tRect.top - cRect.top - sadPenguinAnimator.offsetHeight + 10;
          sadPenguinAnimator.style.transform = `translate(${tX}px, ${tY}px)`;
          sadPenguinAnimator.classList.add("crying");
          await new Promise((r) => setTimeout(r, 2000));
          sadPenguinAnimator.classList.remove("crying");
        }
        function createIceShards(target) {
          const cont = penguinAnimator.parentElement,
            r = target.getBoundingClientRect(),
            cr = cont.getBoundingClientRect(),
            sX = r.left - cr.left + r.width / 2,
            sY = r.top - cr.top + r.height / 2;
          for (let i = 0; i < 10; i++) {
            const sh = document.createElement("div");
            sh.className = "ice-shard";
            sh.style.top = `${sY}px`;
            sh.style.left = `${sX}px`;
            const ang = Math.random() * Math.PI * 2,
              dist = Math.random() * 90 + 50,
              rot = Math.random() * 720 - 360;
            sh.style.setProperty("--tx", `${Math.cos(ang) * dist}px`);
            sh.style.setProperty("--ty", `${Math.sin(ang) * dist - 40}px`);
            sh.style.setProperty("--r", `${rot}deg`);
            cont.appendChild(sh);
            setTimeout(() => sh.remove(), 1000);
          }
        }
        async function animatePenguinBreak(commitmentId) {
          const targetBlock = document.getElementById(commitmentId);
          if (!targetBlock) return;
          const cRect = penguinAnimator.parentElement.getBoundingClientRect(),
            tRect = targetBlock.getBoundingClientRect();
          const tX =
              tRect.left -
              cRect.left +
              tRect.width / 2 -
              penguinAnimator.offsetWidth / 2,
            tY =
              tRect.top -
              cRect.top +
              tRect.height / 2 -
              penguinAnimator.offsetHeight / 2;
          penguinAnimator.style.transition = "transform 0.5s ease-in-out";
          penguinAnimator.style.transform = `translate(${tX}px, ${tY}px)`;
          await new Promise((r) => setTimeout(r, 500));
          penguinAnimator.classList.add("smashing");
          playPickaxeSound();
          createIceShards(targetBlock);
          const phrase = phrases[Math.floor(Math.random() * phrases.length)];
          motivationalPhraseEl.textContent = phrase;
          motivationalPhraseEl.classList.add("visible");
          setTimeout(
            () => motivationalPhraseEl.classList.remove("visible"),
            2000
          );
          await new Promise((r) => setTimeout(r, 600));
          penguinAnimator.classList.remove("smashing");
          penguinAnimator.style.transform = "translateX(-50%)";
          await new Promise((r) => setTimeout(r, 700));
        }

        function showHistory() {
          const content = document.getElementById("history-content");
          content.innerHTML = "";
          if (history.length === 0) {
            content.innerHTML =
              '<p class="text-slate-400 text-center">Nenhuma semana foi finalizada ainda.</p>';
          } else {
            history.forEach((week, index) => {
              const weekDiv = document.createElement("div");
              weekDiv.className = "bg-slate-700/50 p-4 rounded-lg";
              let goalsHtml = '<ul class="list-disc list-inside text-sm mt-2">';
              week.groups
                .flatMap((g) => g.commitments)
                .forEach((c) => {
                  goalsHtml += `<li class="${
                    c.status === "completed" ? "text-green-400" : "text-red-400"
                  }">${c.text}</li>`;
                });
              goalsHtml += "</ul>";

              const allCommitments = week.groups.flatMap((g) =>
                g.commitments.map((c) => ({ ...c, md: g.md }))
              );
              const completedMD1 = allCommitments.filter(
                (c) => c.md === 1 && c.status === "completed"
              ).length;
              const totalMD1 = allCommitments.filter((c) => c.md === 1).length;
              const percMD1 =
                totalMD1 > 0 ? Math.round((completedMD1 / totalMD1) * 100) : 0;
              const completedMD2 = allCommitments.filter(
                (c) => c.md === 2 && c.status === "completed"
              ).length;
              const totalMD2 = allCommitments.filter((c) => c.md === 2).length;
              const percMD2 =
                totalMD2 > 0 ? Math.round((completedMD2 / totalMD2) * 100) : 0;

              weekDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                           <div>
                                <h3 class="fun-font text-xl text-cyan-300">${week.groups
                                  .map((g) => g.text)
                                  .join(" & ")}</h3>
                                <p class="text-xs text-slate-400">Finalizada em: ${
                                  week.date
                                }</p>
                                <div class="text-sm mt-2">
                                    <span class="font-semibold text-cyan-400">MD 1:</span> <span class="text-green-400">${percMD1}%</span> | 
                                    <span class="font-semibold text-cyan-400">MD 2:</span> <span class="text-green-400">${percMD2}%</span>
                                </div>
                                ${goalsHtml}
                           </div>
                           <div class="text-right">
                                <h4 class="fun-font text-lg text-cyan-400 mb-2">Reports</h4>
                                <div class="relative w-48 h-32 bg-slate-800 rounded">
                                    <canvas id="history-chart-${index}"></canvas>
                                </div>
                                <button class="expand-history-chart-btn mt-2 text-xs" data-index="${index}">Expandir ‚ÜóÔ∏è</button>
                           </div>
                        </div>`;
              content.appendChild(weekDiv);
              renderReportChart(
                week.reportChartData,
                `history-chart-${index}`,
                true
              );
            });
            document
              .querySelectorAll(".expand-history-chart-btn")
              .forEach((b) => {
                b.onclick = () =>
                  expandChart(history[b.dataset.index].reportChartData);
              });
          }
          historyScreen.classList.add("visible");
        }

        function renderResultsChart(
          completedMD1,
          failedMD1,
          completedMD2,
          failedMD2
        ) {
          const ctx = document.getElementById("resultsChart").getContext("2d");
          if (resultsChartInstance) resultsChartInstance.destroy();
          resultsChartInstance = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: [
                "MD1 Conclu√≠das",
                "MD1 N√£o Conclu√≠das",
                "MD2 Conclu√≠das",
                "MD2 N√£o Conclu√≠das",
              ],
              datasets: [
                {
                  data: [completedMD1, failedMD1, completedMD2, failedMD2],
                  backgroundColor: ["#22c55e", "#ef4444", "#38bdf8", "#ef4444"],
                  borderColor: "#1e293b",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
            },
          });
        }

        function addReportEntry() {
          const count = parseInt(reportCountInput.value);
          if (!isNaN(count)) {
            reportData.weeks.push(`Semana ${reportData.weeks.length + 1}`);
            reportData.counts.push(count);
            reportCountInput.value = "";
            localStorage.setItem("mciReportData", JSON.stringify(reportData));
            renderReportChart(reportData, "reportChart", false);
          }
        }

        function renderReportChart(data, canvasId, isMini) {
          const ctx = document.getElementById(canvasId).getContext("2d");
          let instanceVar;
          if (canvasId === "reportChart") instanceVar = "reportChartInstance";
          else if (canvasId === "resultsReportChart")
            instanceVar = "resultsReportChartInstance";
          else if (canvasId === "expandedReportChart")
            instanceVar = "expandedReportChartInstance";
          else instanceVar = null;

          if (instanceVar && window[instanceVar]) window[instanceVar].destroy();

          const chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: data.weeks,
              datasets: [
                {
                  label: "Reports Abertos",
                  data: data.counts,
                  borderColor: "#38bdf8",
                  backgroundColor: "rgba(56, 189, 248, 0.2)",
                  fill: true,
                  tension: 0.1,
                },
                {
                  label: "Valor Inicial",
                  data: Array(data.weeks.length).fill(1127),
                  borderColor: "#f87171",
                  borderDash: [5, 5],
                  fill: false,
                  pointRadius: 0,
                },
                {
                  label: "Meta Final",
                  data: Array(data.weeks.length).fill(450),
                  borderColor: "#4ade80",
                  borderDash: [5, 5],
                  fill: false,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  ticks: { color: "#94a3b8" },
                  grid: { color: "rgba(148, 163, 184, 0.1)" },
                },
                x: {
                  ticks: { color: "#94a3b8", display: !isMini },
                  grid: { display: false },
                },
              },
              plugins: {
                legend: { labels: { color: "#94a3b8" }, display: !isMini },
              },
            },
          });
          if (instanceVar) window[instanceVar] = chart;
        }

        function expandChart(data) {
          chartModal.classList.add("visible");
          renderReportChart(data, "expandedReportChart", false);
        }

        initializeApp();
      });
    </script>
  </body>
</html>
